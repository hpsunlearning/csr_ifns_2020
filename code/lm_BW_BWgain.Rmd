---
title: "draft"
author: "Jincheng Wang"
date: "7/2/2020"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
# Loading library here
library(knitr)
library(tidyverse)
library(readxl)
library(ggrepel)
library(effects)
library(lme4)
library(sjPlot)
library(lmerTest)
library(phyloseq)
library(qiime2R)
library(picante)
library(Hmisc)
library(agricolae)
library(vegan)
library(ape)
library(usedist)
library(grid)
library(gridExtra)
library(gtable)
# library(ggpubr)
```

## settings
### set path
```{r}
path_rec = "~/Dropbox/IFNH CSR/ExperimentRecords/"
temp_out = "~/Dropbox/Rutgers/20210328_RUN_33_IFNH_CSR/output/"
```

### set colors, labs and so on
```{r}
BirthMode_color = c("VF"="#377EB8", "CSR"="#4DAF4A", "CS"="#E41A1C")
Sex_labs = c("F" = "Female", "M" = "Male")
```

### functions
```{r}

```

## Body weight
### Overall, plotting all data
```{r}
BW <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20210224-HS.xlsx"), sheet = "BodyWeightRecords", range = "A1:T2009") %>% filter(!is.na(Weight_g))
BW$BirthMode = factor(BW$BirthMode, levels = c("CS", "CSR","VF"))
BW = BW %>% mutate(covid = case_when(Batch %in% c("Batch9","Batch10") ~ "Post covid",
                                     TRUE ~ "Before covid"))

current_days <- max(BW$TimePoint_Days)

BW_sum <- BW %>% group_by(TimePoint_Days, BirthMode, Sex) %>% summarise(N = n(), Mean = mean(Weight_g), SE = sd(Weight_g)/sqrt(N))

y_max <- ceiling(max(BW$Weight_g)/4)*4
p = ggplot(BW, aes(x = TimePoint_Days, y = Weight_g, color = BirthMode)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_path(aes(group = MouseNo), color = "grey", size = 0.5, alpha = 0.5) +
    geom_smooth(aes(fill = BirthMode), alpha = 0.3) +
    geom_text_repel(data = BW_sum, aes(x = TimePoint_Days, y = Mean, label = N), size = 4, show.legend = F) +
    facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
    scale_x_continuous(breaks = c(seq(7, current_days, 7)), labels = c(seq(7, current_days, 7))/7) + 
    scale_y_continuous(breaks = seq(2, y_max, 4)) +
    scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
    labs(x = "Sampling_Week", y = "Body Weight(g)", title = "C-Section Restoration Project - Body Weight Plots-AllData")
ggsave(filename = paste0())

```

### Summary table
```{r message=FALSE, warning=FALSE}
BW_sum2 <- BW %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% summarise(N = n(), N_batch = unique(Batch) %>% length, N_family = unique(FamilyNo) %>% length(), Mean = mean(Weight_g), SE = sd(Weight_g)/sqrt(N))

BW_sum2 %>% mutate(Count = paste0(N, "(", N_family, ")")) %>% select(BirthMode, Sex, TimePoint_Weeks, Count) %>% spread(key = TimePoint_Weeks, value = Count)
```
### LitterSize
```{r}
a = BW %>% select(FamilyID, LitterSize_Born, LitterSize_InProject) %>% unique()
cor(a$LitterSize_Born,a$LitterSize_InProject)
```

### LMM on bodyweight
```{r}
fit = lm(Weight_g ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BW)
summary(fit)

fit_lme4 = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + Sex + (1|MouseID), data = BW,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fit_lme4)
anova(fit_lme4)

fit_lme4_f1 = lmer(Weight_g ~ TimePoint_Weeks*BirthMode  + (1|MouseID), data = BW %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fit_lme4_f1)
anova(fit_lme4_f1)

fit_lme4_f2 = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BW %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fit_lme4_f2)
anova(fit_lme4_f2)

fit_lme4_m2 = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BW %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fit_lme4_m2)
anova(fit_lme4_m2)
```


## Body Weight gain relative to week 3
```{r}
BWgain= BW %>% filter(TimePoint_Weeks > 2) %>% arrange(MouseID, TimePoint_Weeks) %>% group_by(MouseID) %>% mutate(BW_gain = Weight_g - Weight_g[1], BW_gain_percent = BW_gain/Weight_g[1],N = n()) %>% filter(TimePoint_Weeks > 3, N > 3)

BWgain_sum <- BWgain %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% summarise(N = n(), N_batch = unique(Batch) %>% length, N_family = unique(FamilyNo) %>% length(), Mean = mean(BW_gain_percent), SE = sd(BW_gain_percent)/sqrt(N))


p = ggplot(BWgain, aes(x = TimePoint_Weeks, y = BW_gain, color = BirthMode)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_path(aes(group = MouseID), color = "grey", size = 0.5, alpha = 0.5) +
    geom_smooth(aes(fill = BirthMode), alpha = 0.3) +
    facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
    scale_x_continuous(breaks = c(4:18)) + 
    scale_y_continuous(breaks = seq(2, y_max, 4)) +
    scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
    labs(x = "Sampling_Week", y = "Body Weight gain (g)", title = "") 

p = ggplot(BWgain, aes(x = TimePoint_Weeks, y = BW_gain_percent, color = BirthMode)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_path(aes(group = MouseID), color = "grey", size = 0.5, alpha = 0.5) +
    geom_smooth(aes(fill = BirthMode), alpha = 0.3) +
    facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
    scale_x_continuous(breaks = c(4:18)) + 
    scale_y_continuous(breaks = seq(2, y_max, 4)) +
    scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
    labs(x = "Sampling_Week", y = "Body Weight gain (%)", title = "") 

p = ggplot(BWgain_sum, aes(x = TimePoint_Weeks, y = Mean, color = BirthMode)) + 
    geom_point() + 
    geom_line() + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) + 
    facet_wrap(~Sex) + 
    labs(x = "Sampling_Week", y = "Body Weight gain (%)", title = "")

```

### LMM BW_gain
```{r}
fitgain = lm(BW_gain ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BWgain)
summary(fitgain)

fitgain_lme4 = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + Sex + (1|MouseID), data = BWgain,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgain_lme4)
allEffects(fitgain_lme4)
anova(fitgain_lme4)

fitgain_lme4_f1 = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + (1|MouseID), data =  BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgain_lme4_f1)
allEffects(fitgain_lme4_f1)
anova(fitgain_lme4_f1)

fitgain_lme4_f2 = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data =  BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgain_lme4_f2)
allEffects(fitgain_lme4_f2)
anova(fitgain_lme4_f2)

fitgain_lme4_m2 = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data =  BWgain %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgain_lme4_m2)
allEffects(fitgain_lme4_m2)
anova(fitgain_lme4_m2)
```

### LMM BW_gain_percent
```{r}
fitgainp = lm(BW_gain_percent ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BWgain)
summary(fitgainp)

fitgainp_lme4 = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + Sex + (1|MouseID), data = BWgain,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgainp_lme4)
anova(fitgainp_lme4)

fitgainp_lme4_f1 = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + (1|MouseID), data = BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgainp_lme4_f1)
anova(fitgainp_lme4_f1)

fitgainp_lme4_f2 = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgainp_lme4_f2)
anova(fitgainp_lme4_f2)

fitgainp_lme4_m2 = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BWgain %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
summary(fitgainp_lme4_m2)
anova(fitgainp_lme4_m2)

```

### predict BW_gain_percent
```{r}
dat_n = expand.grid(TimePoint_Weeks =  unique(BWgain$TimePoint_Weeks),
                    BirthMode = unique(BWgain$BirthMode),
                    MouseID = "rand")
dat_n$BWgain_p_f = predict(fitgainp_lme4_f2, newdata = dat_n, allow.new.levels = T)
dat_n$BWgain_p_m = predict(fitgainp_lme4_m2, newdata = dat_n, allow.new.levels = T)

p = ggplot(dat_n, aes(x = TimePoint_Weeks, y = BWgain_p_f, color = BirthMode)) + 
    geom_point() + 
    geom_line(aes(group = BirthMode)) + 
    scale_color_manual(values = BirthMode_color)

p = plot_model(fitgainp_lme4_f2, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(0.5, 3.8), breaks = c(1, 1.5, 2, 2.5, 3, 3.5),labels = scales::percent) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age Weeks", y = "Body Weight Gain (%)", title = "Predicted Value of Body Weight Gain of Female")

p = plot_model(fitgainp_lme4_m2, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(0.5, 3.8), breaks = c(1, 1.5, 2, 2.5, 3, 3.5),labels = scales::percent) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age Weeks", y = "Body Weight Gain (%)", title = "Predicted Value of Body Weight Gain of Male")





```













