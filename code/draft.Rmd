---
title: "draft"
author: "Jincheng Wang"
date: "7/2/2020"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(tidyverse)
library(readxl)
library(ggrepel)
library(effects)
library(lme4)
library(sjPlot)
library(lmerTest)
library(phyloseq)
library(qiime2R)
library(picante)
library(Hmisc)
library(agricolae)
library(vegan)
library(ape)
library(usedist)
library(grid)
library(gridExtra)
library(gtable)
library(ggpubr)
```

## settings
```{r}
# set path
path_rec = "~/Dropbox/IFNH CSR/ExperimentRecords/"
temp_out = "~/Dropbox/Rutgers/20210328_RUN_33_IFNH_CSR/output/"
# set colors, labs and so on
BirthMode_color = c("VF"="#377EB8", "CSR"="#4DAF4A", "CS"="#E41A1C")
Sex_labs = c("F" = "Female", "M" = "Male")
responder_color = c("Responder"="#d95f0e", "Nonresponder"="gray50")
BW_status_color = c("Overweight"="#7570b3", "Normal"="#b3cde3","Underweight"="#66a61e")
# functions
round_anova = function(a){
    a$`Sum Sq` = round(a$`Sum Sq`,2)
    a$`Mean Sq` = round(a$`Mean Sq`,2)
    a$DenDF = round(a$DenDF,2)
    a$`F value` = round(a$`F value`,4)
    a$`Pr(>F)` = round(a$`Pr(>F)`,4)
    a
} 

kw_and_CI = function(wdat, x, y){
  wk = wdat %>% split(., .[x])
  out1 = sapply(wk, function(df){smean.cl.boot(df[y], conf.int = .95)}) %>% t() %>% as.data.frame() %>% rownames_to_column(var = x)
  ktest = kruskal(wdat[y], wdat[x], alpha = 0.05, p.adj="none", group=T, main = "wdat", console=FALSE)
  out2 = ktest$groups %>% rownames_to_column(var = x) %>% select(all_of(x), groups)
  out1 = out1 %>% left_join(out2, by = x )
  out1
}
```

## Body weight
### Body weight
#### Body weight summary
```{r}
BW <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20210402-HS.xlsx"), sheet = "BodyWeightRecords", range = "A1:T2009") %>% filter(!is.na(Weight_g))
BW$BirthMode = factor(BW$BirthMode, levels = c("CS", "CSR","VF"))
BW = BW %>% mutate(covid = case_when(Batch %in% c("Batch9","Batch10") ~ "Post covid",
                                     TRUE ~ "Before covid"))

BW_sum <- BW %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% 
  summarise(N = n(),
            N_batch = unique(Batch) %>% length,
            N_family = unique(FamilyNo) %>% length(),
            Mean = mean(Weight_g), 
            SE = sd(Weight_g)/sqrt(N),
            SD = sd(Weight_g),
            boot.lo = smean.cl.boot(Weight_g, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot.hi = smean.cl.boot(Weight_g, conf.int = .95, B = 1000, na.rm = T, reps = F)[3])

BW_sum %>% mutate(Count = paste0(N, "(", N_family, ")")) %>% select(BirthMode, Sex, TimePoint_Weeks, Count) %>% spread(key = TimePoint_Weeks, value = Count) %>% kable()
```

#### LitterSize
```{r}
a = BW %>% select(FamilyID, LitterSize_Born, LitterSize_InProject) %>% unique()
cor(a$LitterSize_Born,a$LitterSize_InProject)
```

#### Gestational days 
```{r}
FR <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20210224-HS.xlsx"), sheet = "FamilyRecords", na = c("","NA"), range = "A1:V145")
a = table(FR$BirthMode,FR$GestationalDay_Birth)
aa = a %>% as.matrix.data.frame() %>% as.data.frame()
colnames(aa) = colnames(a)
rownames(aa) = rownames(a)
a
```

#### plot body weight
```{r}
p = ggplot(BW, aes(x = TimePoint_Weeks, color = BirthMode)) +
  geom_point(aes(y = Weight_g), size = 0.5, alpha = 0.7) +
  geom_path(aes(y = Weight_g , group = MouseID), size = 0.3, alpha = 0.3) + 
  geom_ribbon(data = BW_sum, alpha = 0.5, size = 0.1,
              aes(x = TimePoint_Weeks, ymin = boot.lo, ymax = boot.hi, group = BirthMode, color = BirthMode, fill = BirthMode)) + 
  #geom_text_repel(data = BW_sum, aes(x = TimePoint_Weeks, y = Mean, label = N), size = 3, show.legend = F) +
  geom_path(data = BW_sum, aes(x = TimePoint_Weeks, y = Mean, group = BirthMode)) + 
  facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
  scale_x_continuous(breaks = c(1:18)) + 
  scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
  labs(x = "Age (Week)", y = "Body Weight (g)", title = "")
ggsave(filename = paste0(temp_out,"body_weight/body_weight_overall.png"), plot = p,
    width = 10, height = 5, units = "in", dpi = 300)
```

#### LMM on bodyweight
```{r}
fit = lm(Weight_g ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BW)
fit_lme4 = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + Sex + (TimePoint_Weeks|MouseID), data = BW,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fit_lme4_f = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BW %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fit_lme4_m = lmer(Weight_g ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BW %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)

a_tab = round_anova(as.data.frame(anova(fit_lme4_f)))    
p = plot_model(fit_lme4_f, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(8, 90), breaks = seq(from = 15, to = 75, by = 5)) + 
    scale_x_continuous(breaks = seq(from = 1, to = 18, by = 2)) + 
    labs(x = "Age (Week)", y = "Body Weight (g)", title = "Predicted Value of Body Weight of Female") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 0.1, xmax = 14, ymin = 65, ymax = 90)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BW_female.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)

a_tab = round_anova(as.data.frame(anova(fit_lme4_m))) 
p = plot_model(fit_lme4_m, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(8, 90), breaks = seq(from = 15, to = 75, by = 5)) + 
    scale_x_continuous(breaks = seq(from = 1, to = 18, by = 2)) + 
    labs(x = "Age (Week)", y = "Body Weight (g)", title = "Predicted Value of Body Weight of Male") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 0.1, xmax = 14, ymin = 65, ymax = 90)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BW_male.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)
```

### Body Weight gain relative to week 3
#### summary
```{r}
BWgain= BW %>% filter(TimePoint_Weeks > 2) %>% arrange(MouseID, TimePoint_Weeks) %>% group_by(MouseID) %>% 
    mutate(BW_gain = Weight_g - Weight_g[1], 
           BW_gain_percent = BW_gain/Weight_g[1],
           N = n()) %>% 
    filter(TimePoint_Weeks > 3, N > 3)

BWgain_sum <- BWgain %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% 
  summarise(N = n(), 
            N_batch = unique(Batch) %>% length, 
            N_family = unique(FamilyNo) %>% length(), 
            Mean = mean(BW_gain), 
            boot.lo = smean.cl.boot(BW_gain, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot.hi = smean.cl.boot(BW_gain, conf.int = .95, B = 1000, na.rm = T, reps = F)[3],
            Mean_p = mean(BW_gain_percent), 
            boot_p.lo = smean.cl.boot(BW_gain_percent, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot_p.hi = smean.cl.boot(BW_gain_percent, conf.int = .95, B = 1000, na.rm = T, reps = F)[3])

BWgain_sum %>% mutate(Count = paste0(N, "(", N_family, ")")) %>% select(BirthMode, Sex, TimePoint_Weeks, Count) %>% spread(key = TimePoint_Weeks, value = Count) %>% kable()
```

#### plot BWgain
```{r}
p = ggplot(BWgain, aes(x = TimePoint_Weeks, color = BirthMode)) +
  geom_point(aes(y = BW_gain),size = 0.5, alpha = 0.7) +
  geom_path(aes(y = BW_gain, group = MouseID), size = 0.3, alpha = 0.2) +
  geom_ribbon(data = BWgain_sum, alpha = 0.3, size = 0.1,
              aes(x = TimePoint_Weeks, ymin = boot.lo, ymax = boot.hi, group = BirthMode, color = BirthMode, fill = BirthMode)) + 
  #geom_text_repel(data = BWgain_sum, aes(x = TimePoint_Weeks, y = Mean, label = N), size = 3, show.legend = F) + 
  geom_path(data = BWgain_sum, aes(x = TimePoint_Weeks, y = Mean, group = BirthMode)) + 
  facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
  scale_x_continuous(breaks = c(4:18)) +
  scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
  labs(x = "Age (Week)", y = "Body Weight gain (g)", title = "") 
ggsave(filename = paste0(temp_out,"body_weight/body_weight_gain_overall.png"), plot = p,
    width = 10, height = 5, units = "in", dpi = 300)

p = ggplot(BWgain, aes(x = TimePoint_Weeks, color = BirthMode)) +
  geom_point(aes(y = BW_gain_percent), size = 0.5, alpha = 0.7) +
  geom_path(aes(y = BW_gain_percent, group = MouseID), size = 0.3, alpha = 0.2) +
  geom_ribbon(data = BWgain_sum, alpha = 0.3, size = 0.1,
              aes(x = TimePoint_Weeks, ymin = boot_p.lo, ymax = boot_p.hi, group = BirthMode, color = BirthMode, fill = BirthMode)) + 
  #geom_text_repel(data = BWgain_sum, aes(x = TimePoint_Weeks, y = Mean, label = N), size = 3, show.legend = F) + 
  geom_path(data = BWgain_sum, aes(x = TimePoint_Weeks, y = Mean_p, group = BirthMode)) + 
  facet_grid(.~Sex,labeller = labeller(Sex = Sex_labs)) +
  scale_x_continuous(breaks = c(4:18)) + 
  scale_y_continuous(breaks = c(1, 1.5, 2, 2.5, 3, 3.5, 4), labels = scales::percent) +
  scale_color_manual(values = BirthMode_color, aesthetics = c("fill", "colour")) +
  labs(x = "Age (Week)", y = "Body Weight gain (%)", title = "") 
ggsave(filename = paste0(temp_out,"body_weight/body_weight_gain_percent_overall.png"), plot = p,
    width = 10, height = 5, units = "in", dpi = 300)
```

#### LMM BW_gain
```{r}
fitgain = lm(BW_gain ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BWgain)
fitgain_lme4 = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + Sex + (TimePoint_Weeks|MouseID), data = BWgain,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fitgain_lme4_f = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data =  BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fitgain_lme4_m = lmer(BW_gain ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data =  BWgain %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)

a_tab = round_anova(as.data.frame(anova(fitgain_lme4_f)))    
p = plot_model(fitgain_lme4_f, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(5, 55)) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age (Week)", y = "Body Weight Gain (g)", title = "Predicted Value of Body Weight Gain of Female") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 4, xmax = 14, ymin = 45, ymax = 55)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BWgain_g_female.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)

a_tab = round_anova(as.data.frame(anova(fitgain_lme4_m)))    
p = plot_model(fitgain_lme4_m, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(5, 55)) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age (Week)", y = "Body Weight Gain (g)", title = "Predicted Value of Body Weight Gain of Male") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 4, xmax = 14, ymin = 45, ymax = 55)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BWgain_g_male.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)
```

#### LMM BW_gain_percent
```{r}
fitgainp = lm(BW_gain_percent ~ TimePoint_Weeks*BirthMode + Sex + LitterSize_Born, data = BWgain)
fitgainp_lme4 = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + Sex + (TimePoint_Weeks|MouseID), data = BWgain,
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fitgainp_lme4_f = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BWgain %>% filter(Sex == "F"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)
fitgainp_lme4_m = lmer(BW_gain_percent ~ TimePoint_Weeks*BirthMode + (TimePoint_Weeks|MouseID), data = BWgain %>% filter(Sex == "M"),
                        control = lmerControl(optimizer ="Nelder_Mead"), REML = F)

a_tab = round_anova(as.data.frame(anova(fitgainp_lme4_f)))    
p = plot_model(fitgainp_lme4_f, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(0.5, 3.8), breaks = c(1, 1.5, 2, 2.5, 3, 3.5),labels = scales::percent) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age (Week)", y = "Body Weight Gain (%)", title = "Predicted Value of Body Weight Gain of Female") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 4, xmax = 15, ymin = 3.2, ymax = 3.8)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BWgain_percent_female.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)

a_tab = round_anova(as.data.frame(anova(fitgainp_lme4_m)))  
p = plot_model(fitgainp_lme4_m, type = "pred", terms = c("TimePoint_Weeks","BirthMode"), colors = BirthMode_color, ci.lvl = .95) + 
    scale_y_continuous(limits = c(0.5, 3.8), breaks = c(1, 1.5, 2, 2.5, 3, 3.5),labels = scales::percent) + 
    scale_x_continuous(breaks = c(4:18)) + 
    labs(x = "Age (Week)", y = "Body Weight Gain (%)", title = "Predicted Value of Body Weight Gain of Male") + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5),
                       text = element_text(face = 'bold'))
p = p + annotation_custom(grob = tableGrob(a_tab, theme = ttheme_minimal(base_size = 6)),
                     xmin = 4, xmax = 15, ymin = 3.2, ymax = 3.8)
ggsave(filename = paste0(temp_out,"body_weight/LMM_BWgain_percent_male.png"), plot = p,
    width = 7, height = 5, units = "in", dpi = 300)

```

### BW status
#### summary range
```{r}
BW2 = BW %>% left_join(BW_sum %>% filter(BirthMode == "VF") %>% select(TimePoint_Weeks, Sex, Mean, SD), by=c("TimePoint_Weeks","Sex")) %>%
    rename(VF.mean = Mean, VF.sd = SD, BirthMode = BirthMode.x) %>% 
    select(-BirthMode.y) %>%
    mutate(BW_status_1SD = case_when(Weight_g > VF.mean + 1*VF.sd ~ "Overweight",
                              Weight_g < VF.mean - 1*VF.sd ~ "Underweight",
                              TRUE ~ "Normal"),
           BW_status_1.5SD = case_when(Weight_g > VF.mean + 1.5*VF.sd ~ "Overweight",
                              Weight_g < VF.mean - 1.5*VF.sd ~ "Underweight",
                              TRUE ~ "Normal"),
           BW_status_2SD = case_when(Weight_g > VF.mean + 2*VF.sd ~ "Overweight",
                              Weight_g < VF.mean - 2*VF.sd ~ "Underweight",
                              TRUE ~ "Normal")) 

mouse_kept_for_curve = BW2 %>% filter(TimePoint_Weeks>14) %>% pull(MouseID) %>% unique()

BW_responder = BW2 %>% filter(MouseID %in% mouse_kept_for_curve) %>% 
  filter(TimePoint_Weeks >3) %>% 
  arrange(MouseID, TimePoint_Weeks) %>%
  group_by(MouseID, BirthMode, Sex) %>% 
  summarise(N_measure = n(),
            N_ow_1SD = sum(BW_status_1SD == "Overweight", na.rm = T),
            N_uw_1SD = sum(BW_status_1SD == "Underweight", na.rm = T),
            N_ow_1.5SD = sum(BW_status_1.5SD == "Overweight", na.rm = T),
            N_uw_1.5SD = sum(BW_status_1.5SD == "Underweight", na.rm = T),
            N_ow_2SD = sum(BW_status_2SD == "Overweight", na.rm = T),
            N_uw_2SD = sum(BW_status_2SD == "Underweight", na.rm = T)) %>% 
    ungroup() %>% 
    mutate(ow_ratio_1SD = N_ow_1SD/N_measure,
           uw_ratio_1SD = N_uw_1SD/N_measure,
           ow_ratio_1.5SD = N_ow_1.5SD/N_measure,
           uw_ratio_1.5SD = N_uw_1.5SD/N_measure,
           ow_ratio_2SD = N_ow_2SD/N_measure,
           uw_ratio_2SD = N_uw_2SD/N_measure,
           BW_grp_1SD = case_when(ow_ratio_1SD > 0.5  ~ "Overweight",
                              uw_ratio_1SD > 0.5  ~ "Underweight",
                              TRUE ~ "Normal"),
           BW_grp_1.5SD = case_when(ow_ratio_1.5SD > 0.5  ~ "Overweight",
                              uw_ratio_1.5SD > 0.5  ~ "Underweight",
                              TRUE ~ "Normal"),
           BW_grp_2SD = case_when(ow_ratio_2SD > 0.5  ~ "Overweight",
                              uw_ratio_2SD > 0.5  ~ "Underweight",
                              TRUE ~ "Normal"))

BW_responder2 = BW2 %>% filter(MouseID %in% mouse_kept_for_curve) %>% 
  filter(TimePoint_Weeks == 15) %>% 
  arrange(MouseID) %>%
  mutate(BW_grp_15week = case_when(BW_status_1.5SD == "Overweight" ~ "Overweight",
                              BW_status_1.5SD == "Underweight"  ~ "Underweight",
                              TRUE ~ "Normal"))

BW_responder = BW_responder %>% left_join(BW_responder2 %>% select(MouseID, BW_grp_15week), by = "MouseID")

BW3 = BW2 %>% left_join(BW_responder %>% select(MouseID, BW_grp_1SD, BW_grp_1.5SD, BW_grp_2SD,BW_grp_15week), by = "MouseID") %>% filter(!is.na(BW_grp_1SD))
BW3 %>% select(MouseID, Sex, BirthMode, BW_grp_1SD) %>% unique() %>% group_by(BirthMode, Sex, BW_grp_1SD) %>% summarise(N = n()) %>% pivot_wider(names_from = BW_grp_1SD, values_from = N) %>% kable()
BW3 %>% select(MouseID, Sex, BirthMode, BW_grp_1.5SD) %>% unique() %>% group_by(BirthMode, Sex, BW_grp_1.5SD) %>% summarise(N = n()) %>% pivot_wider(names_from = BW_grp_1.5SD, values_from = N) %>% kable()
BW3 %>% select(MouseID, Sex, BirthMode, BW_grp_2SD) %>% unique() %>% group_by(BirthMode, Sex, BW_grp_2SD) %>% summarise(N = n()) %>% pivot_wider(names_from = BW_grp_2SD, values_from = N) %>% kable()
BW3 %>% select(MouseID, Sex, BirthMode, BW_grp_15week) %>% unique() %>% group_by(BirthMode, Sex, BW_grp_15week) %>% summarise(N = n()) %>% pivot_wider(names_from = BW_grp_15week, values_from = N) %>% kable()

```

#### plot responder
```{r}
for (sd in c(1, 1.5, 2)){
  for (BM in c("VF","CS","CSR")){
    p = ggplot(data = BW3 %>% filter(BirthMode == BM)) + 
      geom_point(aes(x = TimePoint_Weeks, y = Weight_g, color = get(paste0("BW_grp_", sd, "SD"))), size = 1) + 
      geom_line(aes(x = TimePoint_Weeks, y = Weight_g, color = get(paste0("BW_grp_", sd, "SD")), group = MouseID),alpha = 0.8, size = 0.5) + 
      scale_color_manual(values = BW_status_color, name = "BW status") + 
      geom_line(data = BW_sum %>% filter(BirthMode == "VF"),
              aes(x = TimePoint_Weeks, y = Mean, group = BirthMode), size = 1, color = "#377EB8") + 
      geom_ribbon(data = BW_sum %>% filter(BirthMode == "VF"),
                aes(x = TimePoint_Weeks,ymin = Mean - sd*SD, ymax = Mean + sd*SD, group = BirthMode),fill = "#377EB8", alpha = 0.2) +
      scale_x_continuous(breaks = c(1:18)) + 
      labs(x = "Age in Weeks", y = "Body Weight (g)", title = paste0("Body Wiehgt Status of ", BM, " in ", sd, "SD of VF BW Range" )) + 
      facet_grid(~Sex) 
    ggsave(filename = paste0(temp_out,"body_weight/responder_", sd, "SD_in_", BM, ".png"), plot = p,
      width = 10, height = 5, units = "in", dpi = 300)
  }
}
  
for (BM in c("VF","CS","CSR")){
  p = ggplot(data = BW3 %>% filter(BirthMode == BM)) + 
    geom_point(aes(x = TimePoint_Weeks, y = Weight_g, color = BW_grp_15week), size = 1) + 
    geom_line(aes(x = TimePoint_Weeks, y = Weight_g, color = BW_grp_15week, group = MouseID), alpha = 0.8, size = 0.5) + 
    scale_color_manual(values = BW_status_color, name = "BW status") + 
    geom_line(data = BW_sum %>% filter(BirthMode == "VF"),
              aes(x = TimePoint_Weeks, y = Mean, group = BirthMode), size = 1, color = "#377EB8") + 
    geom_ribbon(data = BW_sum %>% filter(BirthMode == "VF"),
                aes(x = TimePoint_Weeks,ymin = Mean - 1.5*SD, ymax = Mean + 1.5*SD, group = BirthMode),fill = "#377EB8", alpha = 0.2) +
    scale_x_continuous(breaks = c(1:18)) + 
    labs(x = "Age in Weeks", y = "Body Weight (g)", title = paste0("Body Wiehgt Status of ", BM, " in 1.5SD of VF BW Range base on week 15" )) + 
    facet_grid(~Sex) 
  ggsave(filename = paste0(temp_out,"body_weight/responder_15week_1.5SD_in_", BM, ".png"), plot = p,
      width = 10, height = 5, units = "in", dpi = 300)
}

```

### save intermediate data
```{r}
save(BW_responder, BW, BW2, BW3, BWgain, BW_sum, BWgain_sum, file = paste0(path_rec, "processed_16Sdata/temp_BW.RData"))
```


## Fecal 16S
### data process
#### import into phyloseq
```{r}
phylo_all = qza_to_phyloseq(features = paste0(path_rec, "processed_16Sdata/table.qza"),
                         taxonomy = paste0(path_rec, "processed_16Sdata/taxonomy_silva132.qza"),
                         tree =  paste0(path_rec, "processed_16Sdata/rooted_tree.qza"),
                         metadata = paste0(path_rec, "processed_16Sdata/meta_csr.txt"))
```
#### sequence depth
```{r}
my_summarize = function(x){
  data.frame(
             N = n(),
             Min = min(x,na.rm = T),
             Q5 = quantile(x, probs = 0.05, na.rm = T),
             Q10 = quantile(x, probs = 0.1, na.rm = T),
             Q25 = quantile(x, probs = 0.25, na.rm = T),
             Med = median(x, na.rm = T),
             Mean = mean(x, na.rm = T),
             Q75 = quantile(x, probs = 0.75, na.rm = T),
             Q95 = quantile(x, probs = 0.95, na.rm = T),
             Max = max(x,na.rm = T)
             )
}
sample_sums(phylo_all) %>% as.data.frame() %>% summarise(my_summarize(.)) %>% kable()
```
#### metadata
```{r}
meta_all = phylo_all@sam_data@.Data %>% as.data.frame()
names(meta_all) = phylo_all@sam_data@names
meta_all$Sample_name = phylo_all@sam_data@row.names
meta_all$Seq_count = sample_sums(phylo_all)
table(meta_all$BirthMode,meta_all$TimePointInWeeks)
meta_all = meta_all %>% mutate(TimePoint = case_when(TimePointInWeeks == 3 ~ "Week3",
                                          TimePointInWeeks == 6 ~ "Week6",
                                          TimePointInWeeks == 18 ~ "Week18",
                                          TimePointInWeeks %in% c(9,11,12,14) ~ "Week9-14"))
meta_all$TimePoint = factor(meta_all$TimePoint, levels = c("Week3","Week6","Week9-14","Week18"),ordered = T)
table(meta_all$BirthMode,meta_all$TimePoint)
```
#### rarefy
according to the seqence depth summary, set the sequence depth to 3100
```{r message=FALSE, warning=FALSE}
phylo_rf = rarefy_even_depth(phylo_all, sample.size = 3100, rngseed = 1, replace = F, )
```
#### alpha diversity
```{r}
a1 = pd(t(phylo_rf@otu_table@.Data), phylo_rf@phy_tree, include.root = F)
a2 = estimate_richness(phylo_rf, measures="Shannon")
alpha = merge(a1, a2, by=0)
names(alpha) = c("Sample_name", "Faith_PD", "Observed_feature","Shannon")
alpha = alpha %>% left_join(meta_all, by = "Sample_name")
```
#### beta diversity
```{r}
dist_uwunif = UniFrac(phylo_rf, weighted = F)
dist_wunif = UniFrac(phylo_rf, weighted = T)
```
#### save intermediate data
```{r}
save(meta_all, alpha, dist_uwunif, dist_wunif, phylo_all, phylo_rf, file = paste0(path_rec, "processed_16Sdata/temp_16S.RData"))
```

















### general alpha by birthmode by weeks
```{r}
dat = alpha %>% filter(Generation == "F1")
# by TimePointInWeeks
res_summary = data.frame(BirthMode = NA, Mean = NA, Lower = NA, Upper = NA, groups = NA, Weeks = NA, Sex = NA, alpha_metrics = NA )
for(time_point in sort(unique(dat$TimePointInWeeks))){
  for(sex in unique(dat$Sex)){
    wdat = dat %>% filter(TimePointInWeeks == time_point, Sex == sex) 
    for (alpha_metrics in c("Faith_PD", "Observed_feature", "Shannon")){
      res = kw_and_CI(wdat = wdat, x = "BirthMode", y = alpha_metrics)
      res$Weeks = time_point
      res$Sex = sex
      res$alpha_metrics = alpha_metrics
      res_summary = rbind(res_summary, res)
    }  
  }
} 
res_summary = res_summary %>% filter(!is.na(BirthMode))

for (a in c("Faith_PD", "Observed_feature", "Shannon")){
  p = ggplot(data = res_summary %>% filter(alpha_metrics == a), 
           aes(x = Weeks, y = Mean, ymin = Lower, ymax = Upper, color = BirthMode)) + 
    geom_line(aes(group = BirthMode),size = 1.5) + 
    scale_x_continuous(breaks = c(3,6,9,11,12,14,18)) +
    labs(x = "Age Weeks", y = a) + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) + 
    geom_ribbon(aes(group = BirthMode, fill = BirthMode), alpha = 0.2) + 
    facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
  ggsave(filename = paste0(temp_out,"alpha_by_weeks/weeks_ribbon_",a,".png"),
         plot = p, width = 16, height = 12, units = "cm", dpi = 300)  
    
  p = ggplot(data = alpha %>% filter(Generation == "F1"),
           aes(x = factor(TimePointInWeeks), y = get(a), color = BirthMode)) + 
    geom_boxplot() + 
    labs(x = "Age Weeks", y = a) + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) + 
    facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
    ggsave(filename = paste0(temp_out,"alpha_by_weeks/weeks_boxplot_",a,".png"),
         plot = p, width = 14, height = 10, units = "in", dpi = 300)  
}
# by TimePoint
res_summary2 = data.frame(BirthMode = NA, Mean = NA, Lower = NA, Upper = NA, groups = NA, Weeks = NA, Sex = NA, alpha_metrics = NA )
for(time_point in sort(unique(dat$TimePoint))){
  for(sex in unique(dat$Sex)){
    wdat = dat %>% filter(TimePoint == time_point, Sex == sex) 
    for (alpha_metrics in c("Faith_PD", "Observed_feature", "Shannon")){
      res = kw_and_CI(wdat = wdat, x = "BirthMode", y = alpha_metrics)
      res$Weeks = time_point
      res$Sex = sex
      res$alpha_metrics = alpha_metrics
      res_summary2 = rbind(res_summary2, res)
    }  
  }
} 
res_summary2 = res_summary2 %>% filter(!is.na(BirthMode))
res_summary2$Weeks = factor(res_summary2$Weeks, levels = c("Week3","Week6","Week9-14","Week18"),ordered = T)

for (a in c("Faith_PD", "Observed_feature", "Shannon")){
  p = ggplot(data = res_summary2 %>% filter(alpha_metrics == a), 
           aes(x = Weeks, y = Mean, ymin = Lower, ymax = Upper, color = BirthMode)) + 
    geom_line(aes(group = BirthMode),size = 1.5) + 
    labs(x = "Age Weeks", y = a) + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) + 
    geom_ribbon(aes(group = BirthMode, fill = BirthMode), alpha = 0.2) + 
    facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
  ggsave(filename = paste0(temp_out,"alpha_by_weeks/week_f4_ribbon_",a,".png"),
         plot = p, width = 14, height = 10, units = "in", dpi = 300)  
    
  p = ggplot(data = alpha %>% filter(Generation == "F1"),
           aes(x = factor(TimePoint), y = get(a), color = BirthMode)) + 
    geom_boxplot() + 
    labs(x = "Age Weeks", y = a) + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) + 
    facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
    ggsave(filename = paste0(temp_out,"alpha_by_weeks/weeks_f4_boxplot_",a,".png"),
         plot = p, width = 14, height = 10, units = "in", dpi = 300)  
}
```

### beta diversity by birth mode
```{r}
sub_id = meta_all %>% filter(Generation == "F1") %>% select(Sample_name) %>% unlist()
sub_id = intersect(sub_id, labels(dist_uwunif))
wmeta = meta_all[pmatch(sub_id,meta_all$Sample_name),]

for (D_id in c("dist_uwunif", "dist_wunif")){
  wdist = dist_subset(get(D_id),sub_id)
  dtitle = ifelse (D_id == "dist_uwunif", "Unweighted UniFrac", "Weighted UniFrac")
  set.seed(1)
  x = as.data.frame(adonis2(wdist ~ BirthMode + TimePoint, data = wmeta, by = "margin"))
  x = x[which(!(rownames(x) %in% c("Residual","Total"))),]
  x$SumOfSqs = round(x$SumOfSqs,4)
  x$F = round(x$F,4)
  x$`Pr(>F)` = round(x$`Pr(>F)`,4)
  x$R2 = paste0(round(x$R2*100,2), " %")

  wpcoa = pcoa(wdist)
  varPC1 <- round(wpcoa$values$Relative_eig[1]*100, 2)
  varPC2 <- round(wpcoa$values$Relative_eig[2]*100, 2)
  varPC3 <- round(wpcoa$values$Relative_eig[3]*100, 2)
  wdat = merge(wpcoa$vectors[,1:2],wmeta, by.x = 0, by.y = "Sample_name")
  
  xmin = min(wdat$Axis.1) - 0.2 * sum(abs(range(wdat$Axis.1)))
  xmax = max(wdat$Axis.1) + 0.2 * sum(abs(range(wdat$Axis.1)))
  ymin = min(wdat$Axis.2) - 0.2 * sum(abs(range(wdat$Axis.2)))
  ymax = max(wdat$Axis.2) + 0.4 * sum(abs(range(wdat$Axis.2)))
  
  p = ggplot(wdat, aes(x = Axis.1, y = Axis.2, color = BirthMode)) + 
    geom_point(alpha = 0.8, size = 4) + 
    stat_ellipse() + 
    scale_x_continuous(limits = c(xmin, xmax)) +
    scale_y_continuous(limits = c(ymin, ymax)) + 
    scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) +
    labs(x = paste0("PC1: ", varPC1, "% explained variation"),
           y = paste0("PC2: ", varPC2, "% explained variation"),
           title = paste("PcoA by Birth Mode", dtilte, sep = " ")) + 
    theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5), 
                       text = element_text(face = 'bold'),
                       axis.text = element_text(size = 8),
                       axis.title = element_text(size = 10),
                       strip.text = element_text(size=10),
                       legend.text = element_text(size=10),
                       legend.title = element_text(size=10),
                       title = element_text(size=12))
    p = p + annotation_custom(grob = tableGrob(x, theme = ttheme_minimal(base_size = 10)),
                     xmin = xmin + 0.05*sum(abs(c(xmin,xmax))), xmax = xmax - 0.05*sum(abs(c(xmin,xmax))),
                     ymin = ymax - 0.1*sum(abs(c(ymin,ymax))), ymax = ymax)
  ggsave(filename = paste0(temp_out,"beta_by_weeks/","All_Weeks_",dtitle,".png"),
         plot = p, width = 14, height = 10, units = "in", dpi = 300)

  for (time_point in sort(unique(dat$TimePoint))) {
    wwmeta = wmeta %>% filter(TimePoint == time_point)
    wwdist = dist_subset(wdist,wwmeta$Sample_name)
    set.seed(1)
    x = as.data.frame(adonis2(wwdist ~ BirthMode, data = wwmeta, by = "margin"))
    x = x[which(!(rownames(x) %in% c("Residual","Total"))),]
    x$SumOfSqs = round(x$SumOfSqs,4)
    x$F = round(x$F,4)
    x$`Pr(>F)` = round(x$`Pr(>F)`,4)
    x$R2 = paste0(round(x$R2*100,4), " %")
      
    wwpcoa = pcoa(wwdist)
    varPC1 <- round(wwpcoa$values$Relative_eig[1]*100, 2)
    varPC2 <- round(wwpcoa$values$Relative_eig[2]*100, 2)
    varPC3 <- round(wwpcoa$values$Relative_eig[3]*100, 2)
    wwdat = merge(wwpcoa$vectors[,1:2],wwmeta, by.x = 0, by.y = "Sample_name")
  
    xmin = min(wwdat$Axis.1) - 0.2 * sum(abs(range(wwdat$Axis.1)))
    xmax = max(wwdat$Axis.1) + 0.2 * sum(abs(range(wwdat$Axis.1)))
    ymin = min(wwdat$Axis.2) - 0.2 * sum(abs(range(wwdat$Axis.2)))
    ymax = max(wwdat$Axis.2) + 0.4 * sum(abs(range(wwdat$Axis.2)))
    
    p = ggplot(wwdat, aes(x = Axis.1, y = Axis.2, color = BirthMode)) + 
      geom_point(alpha = 0.8, size = 4) + 
      stat_ellipse() + 
      scale_x_continuous(limits = c(xmin, xmax)) +
      scale_y_continuous(limits = c(ymin, ymax)) + 
      scale_color_manual(values = BirthMode_color, aesthetics = c("color","fill")) +
      labs(x = paste0("PC1: ", varPC1, "% explained variation"),
           y = paste0("PC2: ", varPC2, "% explained variation"),
           title = paste("PcoA at", time_point, dtilte, sep = " ")) + 
      theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       plot.title = element_text(hjust = 0.5), 
                       text = element_text(face = 'bold'),
                       axis.text = element_text(size = 8),
                       axis.title = element_text(size = 10),
                       strip.text = element_text(size=10),
                       legend.text = element_text(size=10),
                       legend.title = element_text(size=10),
                       title = element_text(size=12))
    p = p + annotation_custom(grob = tableGrob(x, theme = ttheme_minimal(base_size = 10)),
                     xmin = xmin + 0.05*sum(abs(c(xmin,xmax))), xmax = xmax - 0.05*sum(abs(c(xmin,xmax))),
                     ymin = ymax - 0.1*sum(abs(c(ymin,ymax))), ymax = ymax)
    ggsave(filename = paste0(temp_out,"beta_by_weeks/",time_point,"_",dtitle,".png"),
         plot = p, width = 14, height = 10, units = "in", dpi = 300)
  }
}
```

### Source tracking Mom and pups
#### run FEAST
```{r message=FALSE, warning=FALSE}
library(FEAST)
Family_id_all = meta_all %>% filter(Generation == "F0") %>% pull(FamilyNo)
dat = meta_all %>% filter(FamilyNo %in% Family_id_all)
Family_id = which(table(dat$FamilyNo) > 1) %>% names()
dat = dat %>% filter(FamilyNo %in% Family_id) %>%
  mutate(Env = ifelse(Generation == "F0", "Mom_Vaginal", "Pup_fecal"),
         SourceSink = ifelse(Generation == "F0", "Source", "Sink"),
         id = FamilyNo) %>% 
  select(Sample_name, Env, SourceSink, id) %>% 
  arrange(id, desc(Env))
otu = otu_table(phylo_all) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "id")
## in order to run FEAST without generate error, I have to make the number of sink equal or greater than the number of ids, so I choose to do each mom and pups separately.
res_all = data.frame(Mom_vaginal = NA, Unknown = NA, Sample_name = NA)
for (fid in unique(dat$id)){
  wdat = dat %>% filter(id == fid)
  wdat$id = c(1:nrow(wdat)) 
  wdat = wdat %>% mutate(id = ifelse(SourceSink == "Source", NA, id)) %>%
    column_to_rownames(var = "Sample_name")
  ft = otu %>% select(id, row.names(wdat)) %>% column_to_rownames(var = "id") %>% t()
  ft = ft[,colSums(ft)>0]
  FEAST_output = FEAST(C = ft, metadata = wdat, different_sources_flag = 0, 
                     dir_path = paste0(temp_out,"source_track"), 
                     outfile=paste0(fid, "_mom_unrf"))
  res = FEAST_output %>% rownames_to_column(var = "a") 
  res$Sample_name = str_split(res$a, "_", simplify = T)[,1]
  res = res %>% select(-a)
  names(res) = c("Mom_vaginal","Unknown","Sample_name")
  res_all = rbind(res_all, res)
} 
res_all = res_all %>% filter(!is.na(Sample_name))
source_dat = res_all %>% left_join(meta_all, by = "Sample_name")
```
#### load FEAST result instead
```{r}
Family_id_all = meta_all %>% filter(Generation == "F0") %>% pull(FamilyNo)
dat = meta_all %>% filter(FamilyNo %in% Family_id_all)
Family_id = which(table(dat$FamilyNo) > 1) %>% names()
res_all = data.frame(Mom_vaginal = NA, Unknown = NA, Sample_name = NA)
for (fid in Family_id){
  res = read.table(file = paste0(temp_out,"source_track/",fid,"_mom_unrf_source_contributions_matrix.txt"))
  res = res %>% rownames_to_column(var = "a")
  res$Sample_name = str_split(res$a, "_", simplify = T)[,1]
  res = res %>% select(-a)
  names(res) = c("Mom_vaginal","Unknown","Sample_name")
  res_all = rbind(res_all, res)
} 
res_all = res_all %>% filter(!is.na(Sample_name))
source_dat = res_all %>% left_join(meta_all, by = "Sample_name")
# 2 families failed restoration
```
#### plot
```{r}
p = ggplot(source_dat, aes(x = TimePoint, y = Mom_vaginal)) + 
  geom_point(aes(color = FamilyID)) + 
  geom_line(aes(color = FamilyID,group = MouseID)) + 
  scale_y_continuous(breaks = c(0,0.2,0.4,0.6,0.8),labels = scales::percent) + 
  labs(x = "",y = "Mom Vaginal Source Proportion (%)", title = "") + 
 # facet_wrap(~Sex) + 
  theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       text = element_text(face = 'bold'),
                       axis.text = element_text(size = 16),
                       axis.title = element_text(size = 17),
                       strip.text = element_text(size=18),
                       legend.text = element_text(size=16),
                       legend.title = element_text(size=17),
                       title = element_text(size=18))
ggsave(filename = paste0(temp_out,"source_track/by_family_Mom_vaginal.png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300) 
```

### sharing ASV  Mom and pups
```{r}
Family_id_all = meta_all %>% filter(Generation == "F0") %>% pull(FamilyNo)
dat = meta_all %>% filter(FamilyNo %in% Family_id_all)
Family_id = which(table(dat$FamilyNo) > 1) %>% names()
dat = dat %>% filter(FamilyNo %in% Family_id) %>%
  arrange(FamilyNo, Generation)

otu = otu_table(phylo_all) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "id")
res_all = data.frame(Mom_asv = NA, Pup_asv = NA, Shared = NA, Sample_name = NA)
for (fid in unique(dat$FamilyNo)){
  wdat = dat %>% filter(FamilyNo == fid)
  ft = otu %>% select(id, wdat$Sample_name) %>% column_to_rownames(var = "id") %>% t()
  ft = ft[,colSums(ft)>0]
  Mom_id = wdat %>% filter(Generation == "F0") %>% pull(Sample_name)
  ft_mom = ft[pmatch(Mom_id,row.names(ft)),]
  for(pup in wdat %>% filter(Generation == "F1") %>% pull(Sample_name)){
    ft_pup = ft[pmatch(pup,row.names(ft)),]
    res_all = rbind(res_all,
                    data.frame(Mom_asv = sum(ft_mom>0),
                               Pup_asv = sum(ft_pup>0),
                               Shared = sum(ft_pup*ft_mom > 0),
                               Sample_name = pup))
  }
}
res_all = res_all %>% filter(!is.na(Sample_name))

sharing_dat = res_all %>% left_join(meta_all, by = "Sample_name") %>%
  mutate(share_ratio = Shared/Pup_asv)

sharing_dat %>% group_by(FamilyID, TimePoint) %>% summarise(Mean = mean(Shared)) %>% pivot_wider(names_from =  TimePoint, values_from = Mean) %>% kable()

p = ggplot(sharing_dat, aes(x = TimePoint, y = share_ratio)) + 
  geom_point(aes(color = FamilyID)) + 
  geom_line(aes(color = FamilyID,group = MouseID)) + 
  scale_y_continuous(breaks = c(0,0.2,0.4,0.6,0.8),labels = scales::percent) + 
  labs(x = "",y = "Proportion of Shared ASV in Pup's ASV (%)", title = "") + 
#  facet_wrap(~Sex) + 
  theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       text = element_text(face = 'bold'),
                       axis.text = element_text(size = 16),
                       axis.title = element_text(size = 17),
                       strip.text = element_text(size=18),
                       legend.text = element_text(size=16),
                       legend.title = element_text(size=17),
                       title = element_text(size=18))
ggsave(filename = paste0(temp_out,"source_track/by_family_shared_asv_proportion.png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300) 

p = ggplot(sharing_dat, aes(x = TimePoint, y = Shared)) + 
  geom_point(aes(color = FamilyID)) + 
  geom_line(aes(color = FamilyID,group = MouseID)) + 
  labs(x = "",y = "Number of Shared ASV", title = "") + 
#  facet_wrap(~Sex) + 
  theme_bw() + theme(panel.background = element_rect(fill = NA), 
                       text = element_text(face = 'bold'),
                       axis.text = element_text(size = 16),
                       axis.title = element_text(size = 17),
                       strip.text = element_text(size=18),
                       legend.text = element_text(size=16),
                       legend.title = element_text(size=17),
                       title = element_text(size=18))
ggsave(filename = paste0(temp_out,"source_track/by_family_shared_asv_number.png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300) 

```

### Body weight of CSR success or failed
```{r}
load(file = paste0(path_rec, "processed_16Sdata/temp_BW.RData"))

Family_id_all = meta_all %>% filter(Generation == "F0") %>% pull(FamilyNo)
dat = meta_all %>% filter(FamilyNo %in% Family_id_all)
Family_id = which(table(dat$FamilyNo) > 1) %>% names()

dat = BW %>% filter(FamilyNo %in% Family_id)

p = ggplot(data = BW %>% filter(FamilyNo %in% Family_id)) + 
    geom_point(aes(x = TimePoint_Weeks, y = Weight_g, color = FamilyID), size = 1) + 
    geom_line(aes(x = TimePoint_Weeks, y = Weight_g, color = FamilyID, group = MouseID), alpha = 0.8, size = 0.5) + 
    #scale_color_manual(values = BW_status_color, name = "BW status") + 
    geom_line(data = BW_sum %>% filter(BirthMode == "VF"),
              aes(x = TimePoint_Weeks, y = Mean, group = BirthMode), size = 1, color = "#377EB8") + 
    geom_ribbon(data = BW_sum %>% filter(BirthMode == "VF"),
                aes(x = TimePoint_Weeks,ymin = Mean - 1.5*SD, ymax = Mean + 1.5*SD, group = BirthMode),fill = "#377EB8", alpha = 0.2) +
    scale_x_continuous(breaks = c(1:18)) + 
    labs(x = "Age in Weeks", y = "Body Weight (g)", title = paste0("")) + 
    facet_grid(~Sex) 
  ggsave(filename = paste0(temp_out,"body_weight/responder_15week_1.5SD_in_", BM, ".png"), plot = p,
      width = 10, height = 5, units = "in", dpi = 300)

```



### responder 16S
```{r}
load(file = paste0(path_rec, "processed_16Sdata/temp.RData"))
### alpha
dat = alpha %>% left_join(BW_responder %>% select(MouseID, BW_grp_1SD, BW_grp_1.5SD, BW_grp_2SD, BW_grp_15week), by = "MouseID") %>% 
    filter(Generation == "F1", !is.na(BW_grp_1SD))

 
res_summary = data.frame(BW_grp_1.5SD = NA, Mean = NA, Lower = NA, Upper = NA, groups = NA, Weeks = NA, Sex = NA, alpha_metrics = NA )
for(time_point in sort(unique(dat$TimePoint))){
  for(sex in unique(dat$Sex)){
    wdat = dat %>% filter(TimePoint == time_point, Sex == sex) 
    for (alpha_metrics in c("Faith_PD", "Observed_feature", "Shannon")){
      res = kw_and_CI(wdat = wdat, x = "BW_grp_1.5SD", y = alpha_metrics)
      res$Weeks = time_point
      res$Sex = sex
      res$alpha_metrics = alpha_metrics
      res_summary = rbind(res_summary, res)
    }  
  }
} 
res_summary = res_summary %>% filter(!is.na(alpha_metrics))

for (a in c("Faith_PD", "Observed_feature", "Shannon")){
    p = ggplot(dat, aes(x = TimePoint, y = get(a), color = BW_grp_1.5SD)) + 
        geom_boxplot() + 
        #stat_compare_means() + 
        stat_compare_means(label = "p.signif") + 
        scale_color_manual(values = BW_status_color, aesthetics = c("color","fill"), name = "BW Status") +
        labs(x = "Age Weeks", y = a) + 
        facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
    ggsave(filename = paste0(temp_out,"alpha_by_weeks/BW_status_1.5SD_",a,".png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300)
}

for (a in c("Faith_PD", "Observed_feature", "Shannon")){
    p = ggplot(dat, aes(x = TimePoint, y = get(a), color = BW_grp_1SD)) + 
        geom_boxplot() + 
        #stat_compare_means() + 
        stat_compare_means(label = "p.signif") + 
        scale_color_manual(values = BW_status_color, aesthetics = c("color","fill"), name = "BW Status") +
        labs(x = "Age Weeks", y = a) + 
        facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
    ggsave(filename = paste0(temp_out,"alpha_by_weeks/BW_status_1SD_",a,".png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300)
}

for (a in c("Faith_PD", "Observed_feature", "Shannon")){
    p = ggplot(dat, aes(x = TimePoint, y = get(a), color = BW_grp_15week)) + 
        geom_boxplot() + 
        #stat_compare_means() + 
        stat_compare_means(label = "p.signif") + 
        scale_color_manual(values = BW_status_color, aesthetics = c("color","fill"), name = "BW Status") +
        labs(x = "Age Weeks", y = a) + 
        facet_wrap(~Sex, labeller = labeller(Sex = Sex_labs))
    ggsave(filename = paste0(temp_out,"alpha_by_weeks/BW_status_15Week_",a,".png"),
         plot = p, width = 7, height = 5, units = "in", dpi = 300)
}
```




















## DEXA
```{r}
MM <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20200701-JW.xlsx"), sheet = "MouseMetadata")

MM_dexa <- MM %>% filter(ExperimentSet=="Set1-BW", ReasonTermination %in% c("DEXA", "Week18Termination")) %>% mutate(TimePoint_Weeks = ifelse(ReasonTermination=="DEXA", 6, 18))



MM_dexa %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% summarise(N_family = length(unique(FamilyID)), N = length(unique(MouseID))) %>% mutate(Count = paste0(N, " (", N_family, ")")) %>% select(BirthMode, Sex, TimePoint_Weeks, Count) %>% spread(key = TimePoint_Weeks, value = Count) %>% View

spread(key = Sex, value = N)
```

## Behavior
```{r}
Beh <- read_excel(paste0(path_rec, "BehaviorAnimalMetadata-20190124-JW.xlsx"))

Beh %>% filter(Batch != "NA") %>% group_by(BirthMode, Sex) %>% summarise(N_family = length(unique(FamilyID)), N = length(unique(MouseNo))) %>%  mutate(Count = paste0(N, " (", N_family, ")")) 
```

## Feces

```{r}
MM <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20200701-JW.xlsx"), sheet = "SampleMetadata")
MM_fec <- MM %>% filter(BodySite=="Feces")
MM_fec$TimePointInWeeks[MM_fec$TimePointInWeeks %in% c(11, 14)] = "11/14"

MM_fec %>% group_by(TimePointInWeeks, BirthMode, Sex) %>% summarise(N_family = length(unique(FamilyID)), N = length(unique(MouseID))) %>% mutate(Count = paste0(N, " (", N_family, ")")) %>% select(BirthMode, Sex, TimePointInWeeks, Count) %>% spread(key = TimePointInWeeks, value = Count) %>% View
```

## Sac
```{r}
MM <- read_excel(paste0(path_rec, "MasterMetadata-CS-SW-Oct2019-20200701-JW.xlsx"), sheet = "SampleMetadata")
Sac <- MM %>% filter(!SampleType %in% c("Feces", "Empty"))
Sac$BirthMode[Sac$BirthMode=="VD"] <- "VF"

Sac %>% group_by(TimePointInWeeks, BirthMode, Sex) %>% summarise(N_family = length(unique(FamilyID)), N = length(unique(MouseID))) %>% mutate(Count = paste0(N, " (", N_family, ")")) %>% select(BirthMode, Sex, TimePointInWeeks, Count) %>% spread(key = TimePointInWeeks, value = Count) %>% View

```


